<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Building a K3s Cluster with Fedora CoreOS on Orange Pi 5 Plus -</title><meta name=description content="Lessons from My Unsuccessful Attempt"><meta name=author content="Job Céspedes Ortiz"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"My Dev Blog","url":"https:\/\/jobcespedes.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/jobcespedes.dev\/"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/jobcespedes.dev\/","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/jobcespedes.dev\/2023\/11\/building-a-k3s-cluster-with-fedora-coreos-on-orange-pi-5-plus\/","name":"Building a k3s cluster with fedora core os on orange pi 5 plus"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"Job Céspedes Ortiz"},"headline":"Building a K3s Cluster with Fedora CoreOS on Orange Pi 5 Plus","description":"This blog post summarizes my unsuccessful attempt to build a K3s Cluster on the Orange Pi 5 Plus (opi5\u002b) using Fedora CoreOS (FCOS). It also outlines the steps taken before arriving at that conclusion and presents a list of possible alternatives to achieve a similar result.\nWhy Fedora CoreOS? The main reasons behind selecting FCOS as the Operating System (OS) were:\n  Automatic Updates: Fedora CoreOS follows an automated update model, and reboots can also be orchestrated using Zincati.","inLanguage":"en","wordCount":728,"datePublished":"2023-11-09T11:00:00","dateModified":"2023-11-09T11:00:00","image":"https:\/\/jobcespedes.dev\/img\/me_avatar.png","keywords":["fedora, coreos, k3s, kubernetes, orangepi5, john-17:21"],"mainEntityOfPage":"https:\/\/jobcespedes.dev\/2023\/11\/building-a-k3s-cluster-with-fedora-coreos-on-orange-pi-5-plus\/","publisher":{"@type":"Organization","name":"https:\/\/jobcespedes.dev\/","logo":{"@type":"ImageObject","url":"https:\/\/jobcespedes.dev\/img\/me_avatar.png","height":60,"width":60}}}</script><meta property="og:title" content="Building a K3s Cluster with Fedora CoreOS on Orange Pi 5 Plus"><meta property="og:description" content="Lessons from My Unsuccessful Attempt"><meta property="og:image" content="https://jobcespedes.dev/img/me_avatar.png"><meta property="og:url" content="https://jobcespedes.dev/2023/11/building-a-k3s-cluster-with-fedora-coreos-on-orange-pi-5-plus/"><meta property="og:type" content="website"><meta property="og:site_name" content="My Dev Blog"><meta name=twitter:title content="Building a K3s Cluster with Fedora CoreOS on Orange Pi 5 Plus"><meta name=twitter:description content="Lessons from My Unsuccessful Attempt"><meta name=twitter:image content="https://jobcespedes.dev/img/me_avatar.png"><meta name=twitter:card content="summary_large_image"><link href=https://jobcespedes.dev/img/me.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.94.1"><link rel=alternate href=https://jobcespedes.dev/index.xml type=application/rss+xml title="My Dev Blog"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://jobcespedes.dev/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://jobcespedes.dev/css/highlight.min.css><link rel=stylesheet href=https://jobcespedes.dev/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-159956456-1","auto"),ga("send","pageview"))</script></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://jobcespedes.dev/>My Dev Blog</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"></ul></div><div class=avatar-container><div class=avatar-img-border><a title="My Dev Blog" href=https://jobcespedes.dev/><img class=avatar-img src=https://jobcespedes.dev/img/me_avatar.png alt="My Dev Blog"></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=posts-heading><h1>Building a K3s Cluster with Fedora CoreOS on Orange Pi 5 Plus</h1><hr class=small><h2 class=posts-subheading>Lessons from My Unsuccessful Attempt</h2></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>This blog post summarizes my unsuccessful attempt to build a K3s Cluster on the Orange Pi 5 Plus (opi5+) using Fedora CoreOS (FCOS). It also outlines the steps taken before arriving at that conclusion and presents a list of possible alternatives to achieve a similar result.</p><h2 id=why-fedora-coreos>Why Fedora CoreOS?</h2><p>The main reasons behind selecting FCOS as the Operating System (OS) were:</p><ul><li><p><strong>Automatic Updates</strong>: Fedora CoreOS follows an automated update model, and reboots can also be orchestrated using Zincati.</p></li><li><p><strong>Immutable OS</strong>: The operating system is designed to be immutable, meaning that changes are made by replacing the entire OS image rather than modifying the existing system. This helps improve stability and reproducibility.</p></li><li><p><strong>Container-Optimized</strong>: It is optimized for running containers and container orchestration platforms like Kubernetes. This makes it well-suited for modern cloud-native applications.</p></li><li><p><strong>RPM-OSTree</strong>: Fedora CoreOS uses RPM-OSTree, which allows for atomic updates and rollbacks, making it easier to maintain system consistency and recover from issues.</p></li><li><p><strong>Security</strong>: Frequent updates and immutability contribute to a more secure system. Security patches are quickly applied to minimize vulnerabilities.</p></li><li><p><strong>Community, Ecosystem, and Open Source</strong>: Being part of the Fedora Project and Open Source, Fedora CoreOS benefits from a vibrant community and a rich ecosystem of tools and applications.</p></li><li><p><strong>Don&rsquo;t start from scratch</strong>: As part of <a href=https://krestomatio.com/>Krestomatio tools for automating infrastructure</a>, a <a href=https://registry.terraform.io/modules/krestomatio/butane-snippets/ct/latest/submodules/k3s>terraform module</a> was developed to help the deployment of a K3s Cluster using FCOS. The module outputs ignitions (ign) files required, just by setting some variables.</p></li></ul><h2 id=warning>Warning</h2><p>There are a couple of things you should be aware of:</p><ul><li>This is a laboratory environment.</li><li>Ensure that you use the correct official images and URL for your device model, where aplicable. For instance, the opi5+ images and urls differs from the opi5 ones.</li><li>Some steps involve commands that will erase data.</li></ul><h2 id=assumptions>Assumptions</h2><p>The following assumptions have been made:</p><ul><li>Device is Orange Pi 5+ version.</li><li>There is another Fedora-based laptop/PC for preparations.</li></ul><h2 id=preparations>Preparations</h2><h3 id=items>Items</h3><p>The items used for this task are:</p><ul><li>1x SD Card with at least 4GB</li><li>1x USB Drive with at least 4GB</li><li>1x Orange Pi5 Plus 16G + 256G EMMC</li></ul><h3 id=sd-card>SD Card</h3><p>For the SD card:</p><ul><li>Check SD card requirements in <a href=http://www.orangepi.org/>opi5+ manual</a></li><li>Install OS image, following the <a href=http://www.orangepi.org/>opi5 official docs for burning it to the SD</a>.</li></ul><h3 id=usb-drive>USB Drive</h3><p>In the USB drive;</p><ul><li>Copy <a href=https://github.com/edk2-porting/edk2-rk3588/releases>EDK2 latest release</a>, naming it <code>edk2-firmware.img</code></li><li>Copy <a href=#fcos-image>FCOS image</a>, generate in the step below, naming it <code>fcos.img</code></li></ul><h3 id=fcos-image>FCOS image</h3><p>To prepare the FCOS image:</p><ol><li>Create an ignition file and store it in <code>/tmp/config.ign</code></li><li>Create FCOS image</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Create FCOS image</span>
</span></span><span class=line><span class=cl><span class=nv>STREAM</span><span class=o>=</span>next <span class=c1># CHANGEME: `stable` or `testing` or `next`</span>
</span></span><span class=line><span class=cl><span class=nv>FCOS_IMG</span><span class=o>=</span>fcos.img
</span></span><span class=line><span class=cl><span class=nv>IGN_FILE</span><span class=o>=</span>/tmp/config.ign <span class=c1># CHANGEME</span>
</span></span><span class=line><span class=cl><span class=nv>CONTAINER_BUILDER</span><span class=o>=</span>podman <span class=c1># CHANGEME: `podman` or `docker`</span>
</span></span><span class=line><span class=cl>sudo losetup -D
</span></span><span class=line><span class=cl>rm -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PWD</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>FCOS_IMG</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>truncate -s 3GB <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PWD</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>FCOS_IMG</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>sudo losetup -f -P <span class=s2>&#34;</span><span class=si>${</span><span class=nv>PWD</span><span class=si>}</span><span class=s2>/</span><span class=si>${</span><span class=nv>FCOS_IMG</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>sudo <span class=nv>$CONTAINER_BUILDER</span> run --pull<span class=o>=</span>always --privileged --rm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -v /dev:/dev -v /run/udev:/run/udev -v <span class=nv>$IGN_FILE</span>:<span class=nv>$IGN_FILE</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  quay.io/coreos/coreos-installer:release <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  install --firstboot-args<span class=o>=</span><span class=nv>console</span><span class=o>=</span>tty0 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -p <span class=s2>&#34;metal&#34;</span> -a aarch64 -s <span class=nv>$STREAM</span> -i <span class=nv>$IGN_FILE</span> /dev/loop0
</span></span><span class=line><span class=cl>sudo sync
</span></span><span class=line><span class=cl>sudo losetup -D
</span></span></code></pre></div><h2 id=first-boot>First Boot</h2><p>Once preparations are done, continue:</p><ol><li>Insert and boot from SD Card</li><li>Insert USB drive and mount it to <code>/mnt</code></li><li>Copy <a href=#edk2-to-spi>EDK2 to SPI, following steps below</a></li><li>Copy <a href=#fcos-image-to-emmc>FCOS image to eMMC, following steps below</a></li><li>Power off</li><li>Remove SD Card</li><li>Boot from eMMC</li></ol><h3 id=edk2-to-spi>EDK2 to SPI</h3><p>To install EDK2 to SPI:</p><ol><li>Erase SPI</li><li>Copy EDK2 to SPI</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># erase SPI
</span></span><span class=line><span class=cl>sudo dd if=/dev/zero of=/dev/mtdblock0
</span></span><span class=line><span class=cl>sudo sync
</span></span><span class=line><span class=cl># copy EDK2 to SPI
</span></span><span class=line><span class=cl>sudo dd if=edk2-firmware.img of=/dev/mtdblock0
</span></span><span class=line><span class=cl>sudo sync
</span></span></code></pre></div><h3 id=fcos-image-to-emmc>FCOS image to eMMC</h3><ol><li>Identify eMMC device</li><li>Erase eMMC device</li><li>Copy FCOS image to eMMC</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># identify emmc device. Ex: /dev/mmcblk1
</span></span><span class=line><span class=cl>ls /dev/mmcblk*boot0 | cut -c1-12
</span></span><span class=line><span class=cl># erase
</span></span><span class=line><span class=cl>sudo dd bs=1M if=/dev/zero of=/dev/mmcblk1 count=1000 status=progress
</span></span><span class=line><span class=cl>sudo sync
</span></span><span class=line><span class=cl># copy
</span></span><span class=line><span class=cl>sudo dd bs=1M if=fcos.img of=/dev/mmcblk1 count=1000 status=progress
</span></span><span class=line><span class=cl>sudo sync
</span></span></code></pre></div><h2 id=result>Result</h2><blockquote><p>Remember to power off and remove the SD card. Then test booting from FCOS image in eMMC on the opi5+.</p></blockquote><p>The generic FCOS image does not work out of the box. It throws the error <code>Timed out wating for device</code> for boot and root devices and then enters emergency mode. Attempts to run using F39 and F40 were made, with the same result though.</p><h2 id=alternatives>Alternatives</h2><p>After this result, there are three alternatives I am considering to build a K3s Cluster using opi5+ devices. Those are:</p><ol><li>Use official or third party images + K3s</li><li>Use <a href=https://github.com/Joshua-Riek/ubuntu-rockchip#installation>Ubuntu + Libvirt</a> + Fedora CoreOS VM + K3s</li><li>Build a custom Fedora CoreOS, with <a href=https://github.com/orangepi-xunlong/linux-orangepi>Orange Pi linux Kernel</a> + K3s</li></ol><div class=blog-tags><a href=https://jobcespedes.dev//tags/fedora/>fedora</a>&nbsp;
<a href=https://jobcespedes.dev//tags/coreos/>coreos</a>&nbsp;
<a href=https://jobcespedes.dev//tags/k3s/>k3s</a>&nbsp;
<a href=https://jobcespedes.dev//tags/kubernetes/>kubernetes</a>&nbsp;
<a href=https://jobcespedes.dev//tags/orangepi5/>orangepi5</a>&nbsp;
<a href=https://jobcespedes.dev//tags/john-1721/>john-17:21</a>&nbsp;</div><h4 class=see-also>See also</h4><ul><li><a href=/2023/11/building-a-k3s-cluster-with-armbian-on-orange-pi-5-plus/>Building a K3s Cluster with Armbian on Orange Pi 5 Plus</a></li><li><a href=/2023/11/running-virtual-machines-on-orange-pi-5/>Running Virtual Machines on Orange Pi 5</a></li><li><a href=/2022/01/a-keydb-operator/>A KeyDB Operator</a></li><li><a href=/2021/07/a-kubernetes-nfs-operator/>A Kubernetes NFS Operator</a></li><li><a href=/2021/06/a-minimal-container-image-for-rocky-linux-8/>A Minimal Container Image for Rocky Linux 8</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://jobcespedes.dev/2023/11/running-virtual-machines-on-orange-pi-5/ data-toggle=tooltip data-placement=top title="Running Virtual Machines on Orange Pi 5">&larr; Previous Post</a></li><li class=next><a href=https://jobcespedes.dev/2023/11/building-a-k3s-cluster-with-armbian-on-orange-pi-5-plus/ data-toggle=tooltip data-placement=top title="Building a K3s Cluster with Armbian on Orange Pi 5 Plus">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=https://github.com/jobcespedes title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://gitlab.com/jobcespedes title=GitLab><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-gitlab fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/jobcespedes title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted">Job Céspedes Ortiz
&nbsp;&bull;&nbsp;&copy;
2023
&nbsp;&bull;&nbsp;
<a href=https://jobcespedes.dev/>My Dev Blog</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.94.1</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script>
<script src=https://jobcespedes.dev/js/main.js></script>
<script src=https://jobcespedes.dev/js/highlight.min.js></script>
<script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://jobcespedes.dev/js/load-photoswipe.js></script></body></html>